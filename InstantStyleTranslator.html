<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Style Translator (即時翻譯及風格文膽)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Babel (for JSX support) - Fixed version for stability -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <!-- 3. Import Map for Module Resolution -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <style>
        /* Custom scrollbar for better aesthetics */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3;
        }
    </style>
</head>
<body class="bg-white">
    <div id="root"></div>

    <!-- 4. Application Logic -->
    <!-- Added data-presets="react" to fix the [GLOBAL] Error about targets["esmodules"] -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, MessageCircle, Lightbulb, Settings, Copy, Sparkles, Eraser, Wand2, CheckCircle, X, Loader2, Undo2, SearchCheck, ArrowRight } from 'lucide-react';

        const App = () => {
            // --- State Management ---
            const [inputText, setInputText] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            
            // 狀態：主要翻譯載入中
            const [loading, setLoading] = useState(false);
            // 狀態：擴寫功能載入中
            const [isExpanding, setIsExpanding] = useState(false);
            // 狀態：文法檢查載入中
            const [isChecking, setIsChecking] = useState(false);
            // 狀態：拼字檢查載入中
            const [isSpellChecking, setIsSpellChecking] = useState(false);
            
            // 狀態：儲存擴寫前的原始文字 (用於復原)
            const [lastInputText, setLastInputText] = useState(null);
            
            const [error, setError] = useState(null);
            
            // 文法檢查結果
            const [grammarResult, setGrammarResult] = useState(null);
            // 拼字檢查結果
            const [spellingResult, setSpellingResult] = useState(null);

            // 儲存生成的結果
            const [results, setResults] = useState({
                professional: { zh: '', en: '' },
                conversational: { zh: '', en: '' },
                creative: { zh: '', en: '' }
            });

            // Debounce Timer
            const debounceTimer = useRef(null);

            // --- Logic ---

            // 處理輸入變更並觸發 API
            const handleInputChange = (e) => {
                const text = e.target.value;
                setInputText(text);
                setGrammarResult(null); 
                setSpellingResult(null); 
                
                if (debounceTimer.current) clearTimeout(debounceTimer.current);

                if (!text.trim()) {
                    setResults({
                        professional: { zh: '', en: '' },
                        conversational: { zh: '', en: '' },
                        creative: { zh: '', en: '' }
                    });
                    return;
                }

                setLoading(true);
                setError(null);

                // 設定 1.2 秒的延遲
                debounceTimer.current = setTimeout(() => {
                    fetchTranslations(text);
                }, 1200);
            };

            // 通用 API 呼叫函數
            const callGemini = async (prompt) => {
                if (!apiKey) {
                    setError("請點擊右上角設定圖示，輸入 API Key 以開始使用 (Please enter API Key)");
                    setShowSettings(true);
                    return null;
                }

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        }
                    );

                    if (!response.ok) throw new Error('API Request Failed');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (err) {
                    console.error(err);
                    setError("連線失敗，請檢查 API Key 或網路連線 (Request failed).");
                    return null;
                }
            };

            // 1. 主要功能：翻譯與風格重寫
            const fetchTranslations = async (text) => {
                const systemPrompt = `
                You are an expert bilingual copywriter (Traditional Chinese <-> English).
                Analyze the input: "${text}".
                Rewrite/translate it into THREE distinct styles for BOTH languages.
                Return ONLY valid JSON:
                {
                    "professional": { "zh": "Formal Chinese", "en": "Formal English" },
                    "conversational": { "zh": "Casual Chinese", "en": "Casual English" },
                    "creative": { "zh": "Marketing Chinese", "en": "Copywriting English" }
                }
                `;

                try {
                    const result = await callGemini(systemPrompt);
                    if (result) {
                        setResults(JSON.parse(result));
                    }
                } finally {
                    setLoading(false);
                }
            };

            // 2. 功能：智慧擴寫
            const handleMagicExpand = async () => {
                if (!inputText.trim()) return;
                setIsExpanding(true);
                setLastInputText(inputText);
                
                const prompt = `
                You are a creative writing assistant. 
                Take the following text and expand it into a well-structured, detailed paragraph.
                Keep the same language as the input.
                Input: "${inputText}"
                Output Requirement:
                Return JSON format: { "expandedText": "Your expanded text here..." }
                `;

                try {
                    const result = await callGemini(prompt);
                    if (result) {
                        const parsed = JSON.parse(result);
                        if (parsed.expandedText) {
                            setInputText(parsed.expandedText);
                            setLoading(true);
                            fetchTranslations(parsed.expandedText);
                        }
                    }
                } finally {
                    setIsExpanding(false);
                }
            };

            // 3. 功能：文法檢查
            const handleGrammarCheck = async () => {
                if (!inputText.trim()) return;
                setIsChecking(true);
                setSpellingResult(null);

                const prompt = `
                You are a strict grammar editor.
                Check the following text for grammatical errors, typos, or awkward phrasing.
                Input: "${inputText}"
                Output Requirement:
                Return JSON format: 
                { 
                    "status": "Clean" or "Issues Found",
                    "feedback": "A short, bulleted list of specific corrections or 'No issues found.' in Traditional Chinese." 
                }
                `;

                try {
                    const result = await callGemini(prompt);
                    if (result) {
                        setGrammarResult(JSON.parse(result));
                    }
                } finally {
                    setIsChecking(false);
                }
            };

            // 4. 功能：拼字檢查
            const handleSpellingCheck = async () => {
                if (!inputText.trim()) return;
                setIsSpellChecking(true);
                setGrammarResult(null);

                const prompt = `
                You are a meticulous English spell checker.
                Analyze the following text. Focus ONLY on English spelling errors. Ignore Chinese characters.
                Input: "${inputText}"
                
                Output Requirement:
                Return JSON format:
                {
                    "hasErrors": boolean,
                    "summary": "String listing the errors found (e.g., 'recieve -> receive, thier -> their'). Use Traditional Chinese for descriptions.",
                    "correctedFullText": "The complete text with spelling errors fixed. Do not change the meaning or style, only fix typos."
                }
                `;

                try {
                    const result = await callGemini(prompt);
                    if (result) {
                        setSpellingResult(JSON.parse(result));
                    }
                } finally {
                    setIsSpellChecking(false);
                }
            };

            // 應用拼字修正
            const applySpellingFix = () => {
                if (spellingResult && spellingResult.correctedFullText) {
                    setLastInputText(inputText);
                    setInputText(spellingResult.correctedFullText);
                    setSpellingResult(null);
                    setLoading(true);
                    fetchTranslations(spellingResult.correctedFullText);
                }
            };

            // 復原功能
            const handleUndo = () => {
                if (lastInputText !== null) {
                    setInputText(lastInputText);
                    setLastInputText(null);
                    setLoading(true);
                    fetchTranslations(lastInputText);
                }
            };

            // 複製功能
            const copyToClipboard = (text) => {
                if (!text) return;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            };

            // --- UI Components ---
            const StyleCard = ({ icon: Icon, title, description, zhContent, enContent, isLoading }) => (
                <div className="flex flex-col bg-white border border-neutral-200 p-6 transition-all duration-300 hover:shadow-lg hover:border-neutral-400 h-full">
                    <div className="flex items-center gap-3 mb-4 border-b border-neutral-100 pb-3">
                        <div className="p-2 bg-neutral-900 text-white rounded-none">
                            <Icon size={18} />
                        </div>
                        <div>
                            <h3 className="font-bold text-neutral-900 tracking-wide uppercase text-sm">{title}</h3>
                            <p className="text-xs text-neutral-500">{description}</p>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col gap-4">
                        <div className="relative group flex-1">
                            <span className="absolute -top-2.5 left-0 bg-white px-1 text-[10px] font-bold text-neutral-400 uppercase tracking-wider">Traditional Chinese</span>
                            <div className={`w-full p-3 bg-neutral-50 border border-neutral-100 text-neutral-800 text-sm leading-relaxed min-h-[80px] ${isLoading ? 'animate-pulse' : ''}`}>
                                {isLoading ? <div className="h-4 bg-neutral-200 rounded w-3/4 mt-1"></div> : zhContent || <span className="text-neutral-300 italic">等待輸入...</span>}
                            </div>
                            {!isLoading && zhContent && (
                                <button onClick={() => copyToClipboard(zhContent)} className="absolute top-2 right-2 text-neutral-300 hover:text-neutral-900 transition-colors">
                                    <Copy size={14} />
                                </button>
                            )}
                        </div>

                        <div className="relative group flex-1">
                            <span className="absolute -top-2.5 left-0 bg-white px-1 text-[10px] font-bold text-neutral-400 uppercase tracking-wider">English</span>
                            <div className={`w-full p-3 bg-neutral-50 border border-neutral-100 text-neutral-800 text-sm leading-relaxed min-h-[80px] font-medium ${isLoading ? 'animate-pulse' : ''}`}>
                                {isLoading ? <div className="h-4 bg-neutral-200 rounded w-1/2 mt-1"></div> : enContent || <span className="text-neutral-300 italic">Waiting for input...</span>}
                            </div>
                            {!isLoading && enContent && (
                                <button onClick={() => copyToClipboard(enContent)} className="absolute top-2 right-2 text-neutral-300 hover:text-neutral-900 transition-colors">
                                    <Copy size={14} />
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-white text-neutral-900 font-sans selection:bg-neutral-900 selection:text-white">
                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md border-b border-neutral-200 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Sparkles size={20} className="text-neutral-900" />
                                <h1 className="text-lg font-bold tracking-tight">TYPE<span className="font-light">MIND</span></h1>
                            </div>
                            <button 
                                onClick={() => setShowSettings(!showSettings)}
                                className={`p-2 transition-colors ${showSettings ? 'text-neutral-900 bg-neutral-100' : 'text-neutral-500 hover:text-neutral-900'}`}
                            >
                                <Settings size={20} />
                            </button>
                        </div>
                        
                        {showSettings && (
                            <div className="border-b border-neutral-200 bg-neutral-50 p-4 animate-in slide-in-from-top-2">
                                <div className="max-w-3xl mx-auto flex flex-col sm:flex-row gap-3 items-center">
                                    <input 
                                        type="password" 
                                        placeholder="Enter your Google Gemini API Key here..." 
                                        value={apiKey}
                                        onChange={(e) => setApiKey(e.target.value)}
                                        className="flex-1 w-full bg-white border border-neutral-300 p-2 text-sm outline-none focus:border-neutral-900 transition-all"
                                    />
                                    <div className="text-xs text-neutral-500">
                                        需要 API Key 才能進行即時運算。
                                    </div>
                                </div>
                            </div>
                        )}
                    </header>

                    {/* Main Content */}
                    <main className="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
                        
                        {/* Input Section */}
                        <section className="mb-8 max-w-3xl mx-auto">
                            <div className="relative">
                                <textarea
                                    value={inputText}
                                    onChange={handleInputChange}
                                    placeholder="在此輸入任何想法... (支援中英混合)"
                                    className="w-full min-h-[160px] p-6 text-xl sm:text-2xl bg-transparent border-b-2 border-neutral-200 focus:border-neutral-900 outline-none resize-none transition-colors placeholder:text-neutral-300 leading-relaxed"
                                    spellCheck="false"
                                />
                                
                                <div className="absolute top-2 right-2 flex gap-2">
                                    {inputText && !loading && (
                                        <button 
                                            onClick={() => {
                                                setInputText(''); 
                                                setLastInputText(null);
                                                setGrammarResult(null);
                                                setSpellingResult(null);
                                                setResults({professional:{zh:'',en:''},conversational:{zh:'',en:''},creative:{zh:'',en:''}})
                                            }} 
                                            className="p-2 text-neutral-300 hover:text-neutral-900 transition-colors"
                                            title="清除全部"
                                        >
                                            <Eraser size={16}/>
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Toolbar */}
                            <div className="flex flex-wrap items-center justify-between mt-4 gap-3">
                                <div className="flex items-center gap-2 text-xs text-neutral-400">
                                    {loading && <span className="animate-pulse flex items-center gap-1"><Loader2 size={12} className="animate-spin"/> 正在生成風格...</span>}
                                </div>
                                
                                <div className="flex gap-3 flex-wrap justify-end">
                                    {lastInputText && (
                                        <button 
                                            onClick={handleUndo}
                                            className="flex items-center gap-2 px-4 py-2 bg-neutral-50 border border-neutral-200 hover:border-neutral-900 text-neutral-700 text-sm transition-all group animate-in fade-in zoom-in"
                                        >
                                            <Undo2 size={14} className="group-hover:text-neutral-900 transition-colors"/>
                                            <span>復原 (Undo)</span>
                                        </button>
                                    )}

                                    <button 
                                        onClick={handleMagicExpand}
                                        disabled={!inputText || isExpanding || isChecking || isSpellChecking}
                                        className="flex items-center gap-2 px-4 py-2 bg-neutral-50 border border-neutral-200 hover:border-neutral-900 text-neutral-700 text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed group"
                                    >
                                        {isExpanding ? <Loader2 size={14} className="animate-spin"/> : <Wand2 size={14} className="group-hover:text-purple-600 transition-colors"/>}
                                        <span>智慧擴寫</span>
                                    </button>

                                    <button 
                                        onClick={handleGrammarCheck}
                                        disabled={!inputText || isExpanding || isChecking || isSpellChecking}
                                        className="flex items-center gap-2 px-4 py-2 bg-neutral-50 border border-neutral-200 hover:border-neutral-900 text-neutral-700 text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed group"
                                    >
                                        {isChecking ? <Loader2 size={14} className="animate-spin"/> : <CheckCircle size={14} className="group-hover:text-green-600 transition-colors"/>}
                                        <span>文法健檢</span>
                                    </button>

                                    <button 
                                        onClick={handleSpellingCheck}
                                        disabled={!inputText || isExpanding || isChecking || isSpellChecking}
                                        className="flex items-center gap-2 px-4 py-2 bg-neutral-50 border border-neutral-200 hover:border-neutral-900 text-neutral-700 text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed group"
                                    >
                                        {isSpellChecking ? <Loader2 size={14} className="animate-spin"/> : <SearchCheck size={14} className="group-hover:text-blue-600 transition-colors"/>}
                                        <span>拼字檢查</span>
                                    </button>
                                </div>
                            </div>

                            {error && <p className="mt-2 text-red-600 text-sm text-center">{error}</p>}
                            
                            {/* Grammar Result Panel */}
                            {grammarResult && (
                                <div className="mt-6 p-4 bg-neutral-50 border-l-4 border-neutral-900 animate-in fade-in slide-in-from-top-2 relative">
                                    <button onClick={() => setGrammarResult(null)} className="absolute top-2 right-2 text-neutral-400 hover:text-neutral-900"><X size={14} /></button>
                                    <h4 className="text-sm font-bold text-neutral-900 uppercase tracking-wider mb-2 flex items-center gap-2">
                                        {grammarResult.status === "Clean" ? <CheckCircle size={14} className="text-green-600"/> : <Sparkles size={14} className="text-yellow-600"/>}
                                        AI 文法分析
                                    </h4>
                                    <div className="text-sm text-neutral-700 leading-relaxed whitespace-pre-line">
                                        {grammarResult.feedback}
                                    </div>
                                </div>
                            )}

                            {/* Spelling Result Panel */}
                            {spellingResult && (
                                <div className="mt-6 p-4 bg-blue-50 border-l-4 border-blue-600 animate-in fade-in slide-in-from-top-2 relative">
                                    <button onClick={() => setSpellingResult(null)} className="absolute top-2 right-2 text-blue-400 hover:text-blue-900"><X size={14} /></button>
                                    <h4 className="text-sm font-bold text-blue-900 uppercase tracking-wider mb-2 flex items-center gap-2">
                                        {spellingResult.hasErrors ? <SearchCheck size={14} className="text-blue-600"/> : <CheckCircle size={14} className="text-green-600"/>}
                                        英文拼字檢查
                                    </h4>
                                    
                                    {spellingResult.hasErrors ? (
                                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                            <div className="text-sm text-blue-800 leading-relaxed whitespace-pre-line">
                                                <p className="font-medium mb-1">發現建議修正：</p>
                                                {spellingResult.summary}
                                            </div>
                                            <button 
                                                onClick={applySpellingFix}
                                                className="whitespace-nowrap px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium shadow-sm transition-colors flex items-center gap-2"
                                            >
                                                應用修正 <ArrowRight size={14}/>
                                            </button>
                                        </div>
                                    ) : (
                                        <p className="text-sm text-blue-800">未發現明顯的英文拼字錯誤。</p>
                                    )}
                                </div>
                            )}
                        </section>

                        {/* Output Grid */}
                        <section className="grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch">
                            <StyleCard icon={BookOpen} title="Professional" description="正式、精煉、商務導向" zhContent={results.professional.zh} enContent={results.professional.en} isLoading={loading}/>
                            <StyleCard icon={MessageCircle} title="Conversational" description="自然、親切、口語化" zhContent={results.conversational.zh} enContent={results.conversational.en} isLoading={loading}/>
                            <StyleCard icon={Lightbulb} title="Creative" description="吸睛、行銷、富有文采" zhContent={results.creative.zh} enContent={results.creative.en} isLoading={loading}/>
                        </section>
                    </main>

                    <footer className="text-center text-neutral-400 text-xs py-8 border-t border-neutral-100 mt-12">
                        <p>AI Powered Style Assistant</p>
                    </footer>
                </div>
            );
        };

        // Render the App
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <div style="color: antiquewhite;">AIzaSyA6lHrLGbAwPFVSP_ymrfrp0khi1cZ0fWc</div>
</body>
</html>