<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš¨æ©Ÿé»åç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 4rem;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 2rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 5rem;
            font-weight: bold;
        }

        .stat-value.called {
            color: #10b981;
        }

        .stat-value.remaining {
            color: #3b82f6;
        }

        .stat-icon {
            font-size: 6rem;
            opacity: 0.3;
        }

        .display-area {
            background: white;
            border-radius: 2rem;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state {
            text-align: center;
            color: #ccc;
        }

        .empty-icon {
            font-size: 8rem;
            margin-bottom: 1rem;
        }

        .empty-text {
            font-size: 3rem;
        }

        .result {
            text-align: center;
            width: 100%;
        }

        .result-label {
            font-size: 3rem;
            color: #666;
            margin-bottom: 2rem;
        }

        .result-card {
            background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            border-radius: 2rem;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .result-name {
            font-size: 6rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1rem;
        }

        .result-id {
            font-size: 3.5rem;
            color: rgba(255,255,255,0.9);
        }

        .animating {
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        button {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 2rem;
            padding: 3rem 2rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        button:active:not(:disabled) {
            transform: scale(0.95);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-pick {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .upload-area {
            background: white;
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
            text-align: center;
        }

        .upload-area h3 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 1.5rem;
            padding: 1.5rem 3rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .file-input-label:hover {
            transform: scale(1.05);
        }

        .file-input-label:active {
            transform: scale(0.95);
        }

        .file-name {
            font-size: 1.5rem;
            color: #666;
            margin-top: 1rem;
            min-height: 2rem;
        }

        .file-name.success {
            color: #10b981;
            font-weight: bold;
        }

        .file-name.error {
            color: #ef4444;
            font-weight: bold;
        }

        .called-list {
            background: white;
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .all-list {
            background: white;
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-top: 1.5rem;
        }

        .all-list h3 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .all-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .all-item {
            background: #f9fafb;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            transition: transform 0.15s, background 0.15s;
        }

        .all-item.called {
            background: #e6fffa;
            opacity: 0.9;
            box-shadow: inset 0 0 0 2px rgba(16,185,129,0.08);
        }

        .called-list h3 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .called-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .called-item {
            background: #f3f4f6;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
        }

        .called-item-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .called-item-id {
            font-size: 1.2rem;
            color: #666;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>éš¨æ©Ÿé»åç³»çµ±</h1>

        <div class="stats">
            <div class="stat-card">
                <div>
                    <div class="stat-label">å·²é»å</div>
                    <div class="stat-value called" id="calledCount">0</div>
                </div>
                <div class="stat-icon">ğŸ‘¥</div>
            </div>
            <div class="stat-card">
                <div>
                    <div class="stat-label">æœªé»å</div>
                    <div class="stat-value remaining" id="remainingCount">0</div>
                </div>
                <div class="stat-icon">ğŸ‘¥</div>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <h3>ğŸ“ ä¸Šå‚³å­¸ç”Ÿåå–®</h3>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".csv" />
                <label for="fileInput" class="file-input-label">
                    <span>ğŸ“¤</span>
                    <span>é¸æ“‡ CSV æª”æ¡ˆ</span>
                </label>
            </div>
            <div class="file-name" id="fileName">è«‹é¸æ“‡ CSV æª”æ¡ˆï¼ˆæ ¼å¼ï¼šid,nameï¼‰</div>
        </div>

        <div class="display-area" id="displayArea">
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">ğŸ“‹</div>
                <div class="empty-text">è«‹å…ˆä¸Šå‚³å­¸ç”Ÿåå–® CSV æª”æ¡ˆ</div>
            </div>
            <div class="result hidden" id="result">
                <div class="result-label">é»åçµæœ</div>
                <div class="result-card" id="resultCard">
                    <div class="result-name" id="resultName"></div>
                    <div class="result-id" id="resultId"></div>
                </div>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-pick" id="btnPick">
                <span>ğŸ²</span>
                <span>éš¨æ©Ÿé»å</span>
            </button>
            <button class="btn-reset" id="btnReset">
                <span>ğŸ”„</span>
                <span>é‡æ–°é–‹å§‹</span>
            </button>
        </div>

        <div class="called-list hidden" id="calledList">
            <h3>å·²é»åå­¸ç”Ÿ</h3>
            <div class="called-grid" id="calledGrid"></div>
        </div>
        <div class="all-list" id="allList">
            <h3>å…¨ç­åå–®</h3>
            <div class="all-grid" id="allGrid"></div>
        </div>
    </div>

    <script>
        const students = [];

        // å¾ä¸Šå‚³çš„CSVæª”æ¡ˆè¼‰å…¥å­¸ç”Ÿè³‡æ–™
        // CSV format expected: id,name (header optional)
        function loadStudentsFromFile(csvText, fileName) {
            students.length = 0; // æ¸…ç©ºç¾æœ‰å­¸ç”Ÿåˆ—è¡¨
            
            try {
                const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);

                if (lines.length === 0) throw new Error('CSVæª”æ¡ˆç‚ºç©º');

                // Detect header like: id,name
                let start = 0;
                const firstCols = lines[0].split(',');
                if (firstCols.length >= 2 && /id/i.test(firstCols[0]) && /name/i.test(firstCols[1])) {
                    start = 1;
                }

                for (let i = start; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    const id = cols[0].trim();
                    const name = cols.slice(1).join(',').trim();
                    if (id && name) students.push({ id, name });
                }

                // If parsing yields nothing, throw error
                if (students.length === 0) throw new Error('ç„¡æ³•è§£æå­¸ç”Ÿè³‡æ–™ï¼Œè«‹ç¢ºèªCSVæ ¼å¼æ­£ç¢º');

                // æˆåŠŸè¼‰å…¥
                fileNameEl.textContent = `âœ“ å·²è¼‰å…¥ ${students.length} ä½å­¸ç”Ÿï¼š${fileName}`;
                fileNameEl.className = 'file-name success';
                
                // æ›´æ–°UI
                updateStats();
                updateCalledList();
                
                // æ›´æ–°ç©ºç‹€æ…‹é¡¯ç¤º
                emptyState.innerHTML = `
                    <div class="empty-icon">ğŸ²</div>
                    <div class="empty-text">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹é»å</div>
                `;
                
                // å•Ÿç”¨æŒ‰éˆ•
                btnPick.disabled = false;
                btnReset.disabled = false;
                
                // é‡ç½®é»åç‹€æ…‹
                calledStudents = [];
                reset();
                
            } catch (err) {
                console.error('Failed to parse CSV:', err);
                fileNameEl.textContent = `âœ— éŒ¯èª¤ï¼š${err.message}`;
                fileNameEl.className = 'file-name error';
                students.length = 0;
                btnPick.disabled = true;
                btnReset.disabled = true;
                updateStats();
                updateCalledList();
            }
        }

        let calledStudents = [];
        let isAnimating = false;

        const btnPick = document.getElementById('btnPick');
        const btnReset = document.getElementById('btnReset');
        const fileInput = document.getElementById('fileInput');
        const fileNameEl = document.getElementById('fileName');
        const calledCount = document.getElementById('calledCount');
        const remainingCount = document.getElementById('remainingCount');
        const emptyState = document.getElementById('emptyState');
        const result = document.getElementById('result');
        const resultCard = document.getElementById('resultCard');
        const resultName = document.getElementById('resultName');
        const resultId = document.getElementById('resultId');
        const calledList = document.getElementById('calledList');
        const calledGrid = document.getElementById('calledGrid');
        const allList = document.getElementById('allList');
        const allGrid = document.getElementById('allGrid');

        // éŸ³æ•ˆåŠŸèƒ½
        let audioContext;
        
        function initAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.warn('Web Audio API not supported');
            }
        }

        // æ’­æ”¾æ»¾å‹•éŸ³æ•ˆï¼ˆå¿«é€Ÿã€é«˜é »ï¼‰
        function playRollingSound() {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800 + Math.random() * 200, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.05);
            } catch (e) {
                console.warn('Failed to play rolling sound:', e);
            }
        }

        // æ’­æ”¾é¸å®šéŸ³æ•ˆï¼ˆæˆåŠŸã€ç¢ºèªéŸ³ï¼‰
        function playSelectionSound() {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                // æ’­æ”¾ä¸€å€‹ä¸Šå‡çš„éŸ³èª¿
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.warn('Failed to play selection sound:', e);
            }
        }

        // æ’­æ”¾é‡ç½®éŸ³æ•ˆ
        function playResetSound() {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.15);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.warn('Failed to play reset sound:', e);
            }
        }

        function updateStats() {
            calledCount.textContent = calledStudents.length;
            remainingCount.textContent = students.length - calledStudents.length;
        }

        function updateCalledList() {
            if (calledStudents.length === 0) {
                calledList.classList.add('hidden');
                // still render all list when no one called
                updateAllList();
                return;
            }

            calledList.classList.remove('hidden');
            calledGrid.innerHTML = '';

            calledStudents.forEach(id => {
                const student = students.find(s => s.id === id);
                const item = document.createElement('div');
                item.className = 'called-item';
                item.innerHTML = `
                    <div class="called-item-name">${student.name}</div>
                    <div class="called-item-id">${student.id}</div>
                `;
                calledGrid.appendChild(item);
            });

            // update the all-list to reflect called state
            updateAllList();
        }

        function updateAllList() {
            if (!allGrid) return;
            allGrid.innerHTML = '';
            // if students not yet loaded, show placeholder
            if (!students || students.length === 0) {
                const p = document.createElement('div');
                p.className = 'all-item';
                p.textContent = 'å°šç„¡å­¸ç”Ÿè³‡æ–™';
                allGrid.appendChild(p);
                return;
            }

            students.forEach(s => {
                const item = document.createElement('div');
                item.className = 'all-item' + (calledStudents.includes(s.id) ? ' called' : '');
                item.innerHTML = `
                    <div class="called-item-name">${s.name}</div>
                    <div class="called-item-id">${s.id}</div>
                `;
                allGrid.appendChild(item);
            });
        }

        function pickRandomStudent() {
            const remaining = students.filter(s => !calledStudents.includes(s.id));

            if (remaining.length === 0) {
                alert('æ‰€æœ‰å­¸ç”Ÿéƒ½å·²è¢«é»å!');
                return;
            }

            isAnimating = true;
            btnPick.disabled = true;
            btnReset.disabled = true;
            resultCard.classList.add('animating');

            emptyState.classList.add('hidden');
            result.classList.remove('hidden');

            let count = 0;
            const interval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * remaining.length);
                const student = remaining[randomIndex];
                resultName.textContent = student.name;
                resultId.textContent = student.id;
                count++;
                
                // æ’­æ”¾æ»¾å‹•éŸ³æ•ˆ
                playRollingSound();

                if (count > 15) {
                    clearInterval(interval);
                    const finalIndex = Math.floor(Math.random() * remaining.length);
                    const selected = remaining[finalIndex];
                    resultName.textContent = selected.name;
                    resultId.textContent = selected.id;
                    calledStudents.push(selected.id);
                    
                    // æ’­æ”¾é¸å®šéŸ³æ•ˆ
                    playSelectionSound();
                    
                    isAnimating = false;
                    btnPick.disabled = false;
                    btnReset.disabled = false;
                    resultCard.classList.remove('animating');
                    
                    updateStats();
                    updateCalledList();
                }
            }, 100);
        }

        function reset() {
            calledStudents = [];
            isAnimating = false;
            
            // æ’­æ”¾é‡ç½®éŸ³æ•ˆ
            playResetSound();
            
            emptyState.classList.remove('hidden');
            result.classList.add('hidden');
            
            // æ ¹æ“šæ˜¯å¦æœ‰å­¸ç”Ÿé¡¯ç¤ºä¸åŒçš„æç¤º
            if (students.length > 0) {
                emptyState.innerHTML = `
                    <div class="empty-icon">ğŸ²</div>
                    <div class="empty-text">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹é»å</div>
                `;
            } else {
                emptyState.innerHTML = `
                    <div class="empty-icon">ğŸ“‹</div>
                    <div class="empty-text">è«‹å…ˆä¸Šå‚³å­¸ç”Ÿåå–® CSV æª”æ¡ˆ</div>
                `;
            }
            
            updateStats();
            updateCalledList();
        }

        btnPick.addEventListener('click', pickRandomStudent);
        btnReset.addEventListener('click', reset);

        // æ–‡ä»¶ä¸Šå‚³è™•ç†
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // æª¢æŸ¥æª”æ¡ˆé¡å‹
            if (!file.name.toLowerCase().endsWith('.csv')) {
                fileNameEl.textContent = 'âœ— éŒ¯èª¤ï¼šè«‹é¸æ“‡ CSV æª”æ¡ˆ';
                fileNameEl.className = 'file-name error';
                return;
            }

            fileNameEl.textContent = `è¼‰å…¥ä¸­ï¼š${file.name}...`;
            fileNameEl.className = 'file-name';

            const reader = new FileReader();
            reader.onload = function(event) {
                const csvText = event.target.result;
                loadStudentsFromFile(csvText, file.name);
            };
            reader.onerror = function() {
                fileNameEl.textContent = 'âœ— éŒ¯èª¤ï¼šç„¡æ³•è®€å–æª”æ¡ˆ';
                fileNameEl.className = 'file-name error';
            };
            reader.readAsText(file, 'UTF-8');
        });

        // åˆå§‹åŒ–
        // disable buttons until students loaded
        btnPick.disabled = true;
        btnReset.disabled = true;
        
        // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±ï¼ˆæŸäº›ç€è¦½å™¨éœ€è¦ç”¨æˆ¶äº¤äº’å¾Œæ‰èƒ½ä½¿ç”¨ï¼‰
        // åœ¨ç”¨æˆ¶ç¬¬ä¸€æ¬¡é»æ“Šæ™‚åˆå§‹åŒ–éŸ³æ•ˆ
        function initAudioOnUserInteraction() {
            if (!audioContext) {
                initAudioContext();
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        // ç›£è½ç”¨æˆ¶äº¤äº’ä»¥å•Ÿç”¨éŸ³æ•ˆ
        document.addEventListener('click', initAudioOnUserInteraction, { once: true });
        document.addEventListener('touchstart', initAudioOnUserInteraction, { once: true });
    </script>
</body>
</html>